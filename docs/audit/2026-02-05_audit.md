# Комплексный аудит Ferum ERP (ERPNext/Frappe) — 2026‑02‑05

## Executive Summary

Текущее состояние системы позволяет развивать проект, но содержит несколько критичных «гигиенических» и
операционных рисков, которые мешают стабильной эксплуатации и усложняют поддержку/масштабирование.

Ключевые результаты аудита (по факту проверки кода/БД/логов):

- Исправлена критичная проблема репозитория `ferum_custom`: в рабочем дереве были закоммичены Git‑артефакты
  (`HEAD`, `objects/`, `refs/` и т.п.), из‑за чего падал `bench version` (GitPython ошибочно определял репозиторий).
- Исправлена группа 500‑ошибок: в БД были активные Script Reports, указывающие на несуществующие python‑модули.
  Они отключены патчем, чтобы не ломать интерфейс.
- Подтверждена работоспособность базовых интеграций (Google Drive, Telegram bot, wkhtmltopdf) через
  `ferum_custom.api.system_health.status`.
- В рамках модернизации реализован Vault‑провайдер (AppRole/Token) и единый типизированный слой настроек,
  но **на конкретном окружении** Vault может оставаться не настроен (требуются `VAULT_*` переменные и политика KV).

Реализация фаз модернизации (см. отчёты в этой папке):

- Phase 1: `phase_1_vault_config.md` — Vault runtime provider + unified settings + security validation.
- Phase 2: `phase_2_technical_debt.md` — legacy read-only + отчёты/инварианты Service Request.
- Phase 3: `phase_3_scaling.md` — contract tests + load runner + scalability notes.

## Таблица проблем и решений (P0–P3)

| Приоритет | Проблема | Риск | Рекомендованное решение | Статус |
|---:|---|---|---|---|
| P0 | В репозитории `ferum_custom` были закоммичены Git‑метаданные в корне | поломка `bench version`, путаница, рост техдолга | удалить артефакты, добавить защиту в `.gitignore` | сделано |
| P0 | В БД активны Script Reports с отсутствующим кодом | 500 при открытии отчётов | отключить отчёты патчем (или восстановить код) | сделано |
| P0 | Разнобой health‑эндпоинтов (операторские проверки) | ложные тревоги/непонятные 404 | унифицировать `/health` и сервисные health‑роуты | сделано |
| P1 | Vault не настроен/не используется для секретов | утечки, ручное управление ключами, трудный аудит доступа | внедрить Vault как источник секретов (AppRole), добавить ротацию | частично (код готов, требуется настройка/rollout) |
| P1 | Конфигурация интеграций размазана по `.env`/DB/кодовой базе | дрейф окружений, сложный релиз | единый слой `settings` + валидатор + health | сделано (код), требуется rollout |
| P2 | Сложная структура python‑пакетов (`ferum_custom` и `ferum_custom.ferum_custom`) | ошибки импортов, высокая цена изменений | плановая нормализация структуры модулей | требуется |
| P2 | Наличие legacy сущностей (Service Project/Service Object) | дублирование моделей, ошибки UI | довести миграцию на стандартные Project/Contract + Project Sites | частично (read-only + отчёты мигрированы) |
| P3 | Расширение CI/регрессии и нагрузочного тестирования | деградации в проде | smoke‑набор, perf‑профилирование, контрактные тесты интеграций | частично (контрактные тесты + load runner) |

## Архитектурные рекомендации (3–5 лет)

### 1) Границы компонентов

- **Frappe/ERPNext** — основной контур данных и бизнес‑логики (авторитетный источник).
- **Telegram bot** — отдельный процесс (webhook/polling), общение с ERP через API, без прямого доступа к БД.
- **FastAPI (если нужен)** — отдельный контур, строго определённый набор задач (уведомления/портал/интеграции),
  единая схема аутентификации и конфигурации.
- **Google Drive** — внешний файловый storage: детерминированная структура папок по Project, хранение метаданных
  в стандартном DocType `File`.
- **Vault** — единственный источник секретов (токены, ключи, service account JSON, внешние auth tokens).

### 2) Конфигурация и секреты

- Ввести единый слой конфигурации: `ferum_custom.config.settings` (типизировано, валидация, redact‑логирование).
- Секреты: читать из Vault (AppRole) и кэшировать в памяти процесса на TTL; `.env` использовать только для
  bootstrap‑параметров Vault и non‑secret настроек.

### 3) Наблюдаемость

- Единый `/api/method/ferum_custom.api.system_health.status` как «панель» интеграций.
- Для отдельных сервисов (telegram bot / fastapi) — `/health` с минимальными проверками.
- Sentry/логирование: единые теги site/app/version, ограничение объёма логов, алерты по категориям.

## План доработок (по этапам)

### Этап 0 (P0, 0–2 дня) — стабилизация

- Репозиторная гигиена (удаление Git‑артефактов, защита `.gitignore`) — сделано.
- Отключение сломанных Report‑записей — сделано.
- Унификация health‑эндпоинтов telegram bot (`/health`) — сделано (требуется перезапуск процесса).

### Этап 1 (P1, 1–2 недели) — безопасность и конфиг

- Подключить Vault (AppRole): `VAULT_ADDR`, `VAULT_MOUNT`, `VAULT_PATH`, `VAULT_ROLE_ID`, `VAULT_SECRET_ID`.
- Реализовать `VaultSettingsProvider`:
  - fetch секретов (KV v2),
  - кэш TTL,
  - строгий allow‑list ключей,
  - фоллбек на `.env` (для локальной разработки).
- Убрать хранение чувствительных токенов в DB‑настройках (или хранить только ссылки/пути к Vault).

### Этап 2 (P2, 1–2 месяца) — техдолг и доменная модель

- Плановая нормализация структуры модулей python (убрать дублирующий namespace).
- Довести миграцию legacy сущностей (Service Project/Service Object) к стандартным Project/Contract + Project Sites:
  - убрать legacy ссылки из UI,
  - оставить read‑only историю,
  - миграционные патчи + регрессионные тесты.

### Этап 3 (P3, 3–6 месяцев) — масштабирование

- Контрактные тесты интеграций (Drive/Vault/Telegram/FastAPI).
- Нагрузочные сценарии (очереди, отчёты, большие проекты, документы).
- Выделение отдельных сервисов при необходимости (но без преждевременного микросервисинга).

## Риски и меры

- **Риск:** дрейф окружений (разные `.env`, разные версии node/python).  
  **Мера:** фиксировать версии, добавить health‑валидацию и CI‑проверки.
- **Риск:** секреты остаются в `.env` и/или базе.  
  **Мера:** Vault + ограничение прав + ротация + журналирование доступа.
- **Риск:** legacy модели продолжают использоваться через меню/поиск.  
  **Мера:** скрыть из Desk UI, оставить доступ только администратору/через миграционные сценарии.
