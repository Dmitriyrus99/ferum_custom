# Audit Snapshot — 2026-02-09

Scope: `/home/frappe/frappe-bench/apps/ferum_custom`

This snapshot focuses on **package/import normalization** and **regression coverage** for reports.

## Summary (what was done)

- Normalized Query Report override location:
  - canonical implementation moved to `ferum_custom/overrides/query_report.py`
  - backward-compatible wrapper kept at `ferum_custom/ferum_custom/overrides/query_report.py`
- Added a bench-executable runtime audit to continuously validate doctypes/reports/workspaces/workflows:
  - `bench --site <site> execute ferum_custom.setup.audit.run`
  - output snapshots under `apps/ferum_custom/docs/audit/*_runtime_audit_<site>.json`
- Generated and committed audit artifacts (no secrets):
  - static import/dependency scan: `docs/audit/import_map_summary.json`
  - package tree inventory: `docs/audit/package_dirs.txt`
  - duplicated path segments list: `docs/audit/duplicated_package_segments.txt`
  - hook import check: `docs/audit/hooks_import_check.txt`
  - doctype/report meta load checks for both sites:
    - `docs/audit/test_site_module_meta_import_failures.txt`
    - `docs/audit/erpclone.ferumrus.ru_module_meta_import_failures.txt`
- Added a regression test for the Query Report runner to prevent `KeyError` on empty filter dicts:
  - `ferum_custom/ferum_custom/tests/test_query_report_override.py`

Full technical report: `docs/package_refactor_report.md`.

## Validation executed

From `apps/ferum_custom`:

- `pre-commit run --all-files`
- `pre-commit run --all-files --hook-stage pre-push`

From bench root:

- `bench --site test_site migrate`
- `bench --site erpclone.ferumrus.ru migrate`
- `bench build --app ferum_custom`
- `bench --site test_site run-tests --app ferum_custom`

## Risks / follow-ups

- The repo still contains a Frappe Module folder with the same name as the app (`ferum_custom/ferum_custom/*`).
  This is expected for the current module naming but remains a source of confusion for new contributors.
  Future refactors should prefer keeping “canonical” runtime code at `ferum_custom/*` and limiting the module
  folder to DocTypes/Reports/fixtures only.
