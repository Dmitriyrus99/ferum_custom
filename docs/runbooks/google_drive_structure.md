# Google Drive — структура папок Ferum (ru_v1)

Цель: детерминированная структура, которая не «ломается» при переименованиях проекта/менеджера/статуса и пригодна для автоматизации.

## 1) Корневая логика

- **Все папки проектов создаются внутри одного root folder** (`FERUM_GOOGLE_DRIVE_ROOT_FOLDER_ID`).
- **У каждого Project — одна корневая папка**, имя детерминировано и основано на `Project.name` (например `PROJ-0003`), а не на пользовательском названии.
- Внутри проекта используются **фиксированные папки‑категории** (на русском).
- Для миграции со старых английских имён используется переименование папок без смены Drive ID (ссылки остаются валидными).

## 2) Дерево папок

```
<ROOT>
└─ 01_ОРГАНИЗАЦИЯ_<company_key>
   └─ 01_ПРОЕКТЫ
      └─ <PROJECT_ID>
         ├─ 00_МЕТА
         │  └─ project.json
         ├─ 01_ДОКУМЕНТЫ
         │  ├─ 01_ДОГОВОРЫ_ЗАКАЗЧИК
         │  │  └─ <CONTRACT_CODE> | _БЕЗ_КОНТРАКТА
         │  ├─ 02_ДОГОВОРЫ_ПОДРЯДЧИКИ
         │  ├─ 03_УДОСТОВЕРЕНИЯ_И_РАЗРЕШЕНИЯ
         │  ├─ 04_ЗАКРЫВАЮЩИЕ_ДОКУМЕНТЫ
         │  │  └─ <YYYY>/<YYYY-MM>/
         │  ├─ 05_КОРРЕСПОНДЕНЦИЯ
         │  │  ├─ 01_ВХОДЯЩИЕ/<YYYY>/<YYYY-MM>/
         │  │  ├─ 02_ИСХОДЯЩИЕ/<YYYY>/<YYYY-MM>/
         │  │  └─ 03_ВНУТРЕННИЕ/<YYYY>/<YYYY-MM>/
         │  ├─ 06_СЛУЖЕБНЫЕ_ДОКУМЕНТЫ/<YYYY>/<YYYY-MM>/
         │  └─ 99_НЕРАЗОБРАННОЕ
         ├─ 02_ОБЪЕКТЫ
         │  └─ <PROJECT_SITE_ROW_ID>
         │     ├─ 00_МЕТА
         │     │  └─ object.json
         │     ├─ 01_ОБСЛЕДОВАНИЕ
         │     └─ 02_ЗАЯВКИ
         └─ 99_АРХИВ
```

Пояснения:

- `<company_key>`: стабилизированная строка из Company (используется как часть имени папки).
- `<PROJECT_ID>`: `Project.name` (стабильно).
- `<PROJECT_SITE_ROW_ID>`: `Project Site.name` (стабильно, не зависит от `site_name`).
- `<CONTRACT_CODE>`: берётся из `Contract.contract_code` (если доступно), иначе используется `Contract.name`.

## 3) Что создаётся автоматически

ERPNext/Frappe (app `ferum_custom`) создаёт структуру через:

- `ferum_custom.api.project_drive.ensure_drive_folders(project)`
- массово: `ferum_custom.api.project_drive.ensure_drive_folders_bulk(...)`

И записывает ссылки:

- `Project.drive_folder_url` — ссылка на папку проекта
- `Project Site.drive_folder_url` — ссылка на папку объекта (строка таблицы)

## 4) Миграция со старых имён

При наличии папок со старой английской структурой выполняется «мягкая» миграция:

- папки **переименовываются** на русский вариант,
- **Drive ID не меняется**, значит старые ссылки остаются рабочими.

## 5) Связь с документами

Документы проектов загружаются в Drive и в ERPNext фиксируются в `File`:

- `File.file_url` — ссылка на Drive (webViewLink)
- `File.ferum_drive_file_id` — Drive file id (для трассировки)
- `File.ferum_doc_title` / `File.ferum_doc_type` — обязательные метаданные
